program test_nufft2

implicit double precision (a-h,o-z)

integer nts,ier,iflag,i
parameter (nts=2**9,iflag=-1)
integer :: rank(2)
double precision eps,r1,r2
parameter (eps=1d-12)
double precision :: result2(nts),c(nts),ts(nts),fk(nts)
double precision,allocatable :: U1r(:,:),U1i(:,:),V1r(:,:),V1i(:,:)
complex*16,allocatable :: U1(:,:),V1(:,:)
complex*16 :: result1(nts)

open(unit = 10,file = 'c.txt')
read(10,*) c
open(unit = 10,file = 'ts.txt')
read(10,*) ts
open(unit = 10,file = 'result2.txt')
read(10,*) result2
open(unit = 10,file = 'rank.txt')
read(10,*) rank
allocate(U1r(nts,rank(1)),U1i(nts,rank(1)))
allocate(V1r(nts,rank(1)),V1i(nts,rank(1)))
allocate(U1(nts,rank(1)),V1(nts,rank(1)))
open(unit = 10,file = 'U1r.txt')
read(10,*) U1r
open(unit = 10,file = 'U1i.txt')
read(10,*) U1i
open(unit = 10,file = 'V1r.txt')
read(10,*) V1r
open(unit = 10,file = 'V1i.txt')
read(10,*) V1i
U1=U1r+dcmplx(0,1)*U1i
V1=V1r+dcmplx(0,1)*V1i

print *,'rank1 = ',rank(1),'rank2 = ',rank(2)
result1=0

do i=1,rank(1)
   call nufft1d2f90(nts,ts,fk,iflag,eps,nts,conjg(V1(:,i))*c,ier)
   result1=result1+U1(:,i)*fk
end do

r1=sqrt(sum((result2-real(result1))*(result2-real(result1))))
r2=sqrt(sum(result2*result2))
print *,'relative error = ',r1/r2

end program